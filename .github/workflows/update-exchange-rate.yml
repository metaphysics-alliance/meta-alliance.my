name: Update Exchange Rate

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch: {}

jobs:
  pull-rate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Pull USD/MYR rate
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          VITE_SUPABASE_EMAIL: ${{ secrets.SUPABASE_EMAIL }}
          VITE_SUPABASE_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
        run: npm run pricing:rate -- USD/MYR

      - name: Pull MYR/USD rate
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          VITE_SUPABASE_EMAIL: ${{ secrets.SUPABASE_EMAIL }}
          VITE_SUPABASE_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
        run: npm run pricing:rate -- MYR/USD

  notify-failure:
    runs-on: ubuntu-latest
    needs: pull-rate
    if: failure()
    steps:
      - name: Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Exchange rate update failed"
          to: admin@meta-alliance.my
          from: ${{ secrets.SMTP_FROM }}
          body: |
            The GitHub Actions workflow "Update Exchange Rate" failed.
            Repository: ${{ github.repository }}
            Run ID: ${{ github.run_id }}
            Check the Actions logs for details.
